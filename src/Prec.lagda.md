# Gradual Guarantee

## Precision on terms

Simple Blame Calculus with proof relevant casts.
Uses polarity to unify upcasts and downcasts.
Uses nested evaluation contexts.

Siek, Thiemann, and Wadler

```
module Prec where

open import Utils
open import Type
open import Core as Core hiding (On-Perform)
open import Progress

import Data.List.Relation.Unary.All as All
import Data.List.Relation.Unary.Any as Any
```


## Precision on contexts

```
infix 4 _â‰¤á´³_
infixl 5 _â–·_

data _â‰¤á´³_ : Context â†’ Context â†’ Set where

  âˆ… :
      ------
      âˆ… â‰¤á´³ âˆ…

  _â–·_ : âˆ€{Î“ Î“â€² A Aâ€²}
    â†’ Î“ â‰¤á´³ Î“â€²
    â†’ A â‰¤ Aâ€²
      ------------------
    â†’ Î“ â–· A â‰¤á´³ Î“â€² â–· Aâ€²

private variable
  Î“ Î“â€² Î” Î”â€² : Context
  Î“â‰¤ : Î“ â‰¤á´³ Î“â€²
  Î”â‰¤ : Î” â‰¤á´³ Î”â€²
  P Pâ€² Q Qâ€² : Typeá¶œ
  A Aâ€² B Bâ€² C : Type
  E Eâ€² F Fâ€² : Effs
  Pâ‰¤ : P â‰¤á¶œ Pâ€²
  Qâ‰¤ : Q â‰¤á¶œ Qâ€²
  Aâ‰¤ : A â‰¤ Aâ€²
  Bâ‰¤ : B â‰¤ Bâ€²
  Eâ‰¤ : E â‰¤áµ‰ Eâ€²
  Fâ‰¤ : F â‰¤áµ‰ Fâ€²
```

## Reflexivity and transitivity of context precision

```
idá´³ : âˆ€ {Î“} â†’ Î“ â‰¤á´³ Î“
idá´³ {âˆ…}      =  âˆ…
idá´³ {Î“ â–· A}  =  idá´³ â–· id

_â¨Ÿá´³_ : âˆ€ {Î“ Î“â€² Î“â€³} â†’ Î“ â‰¤á´³ Î“â€² â†’ Î“â€² â‰¤á´³ Î“â€³ â†’ Î“ â‰¤á´³ Î“â€³
âˆ… â¨Ÿá´³ âˆ…                    =  âˆ…
(Î“â‰¤ â–· Aâ‰¤) â¨Ÿá´³ (Î“â€²â‰¤ â–· Aâ€²â‰¤)  =  (Î“â‰¤ â¨Ÿá´³ Î“â€²â‰¤) â–· (Aâ‰¤ â¨Ÿ Aâ€²â‰¤)

left-idá´³ : âˆ€ {Î“ Î”} â†’ (Î“â‰¤Î” : Î“ â‰¤á´³ Î”) â†’ idá´³ â¨Ÿá´³ Î“â‰¤Î” â‰¡ Î“â‰¤Î”
left-idá´³ âˆ… = refl
left-idá´³ (Î“â‰¤Î” â–· p) rewrite left-idá´³ Î“â‰¤Î” | left-id p = refl

right-idá´³ : âˆ€ {Î“ Î”} â†’ (Î“â‰¤Î” : Î“ â‰¤á´³ Î”) â†’ Î“â‰¤Î” â¨Ÿá´³ idá´³ â‰¡ Î“â‰¤Î”
right-idá´³ âˆ… = refl
right-idá´³ (Î“â‰¤Î” â–· p) rewrite right-idá´³ Î“â‰¤Î” | right-id p = refl
```

## Precision on variables

```
infix 3 _âŠ¢_â‰¤Ë£_â¦‚_

data _âŠ¢_â‰¤Ë£_â¦‚_ : âˆ€ {Î“ Î“â€² A Aâ€²} â†’ Î“ â‰¤á´³ Î“â€² â†’ Î“ âˆ‹ A â†’ Î“â€² âˆ‹ Aâ€² â†’ A â‰¤ Aâ€² â†’ Set where

  Zâ‰¤Z : âˆ€ {Î“ Î“â€² A Aâ€²} {Î“â‰¤ : Î“ â‰¤á´³ Î“â€²} {Aâ‰¤ : A â‰¤ Aâ€²}
      ----------------------
    â†’ Î“â‰¤ â–· Aâ‰¤ âŠ¢ Z â‰¤Ë£ Z â¦‚ Aâ‰¤

  Sâ‰¤S : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€² x xâ€²} {Î“â‰¤ : Î“ â‰¤á´³ Î“â€²} {Aâ‰¤ : A â‰¤ Aâ€²} {Bâ‰¤ : B â‰¤ Bâ€²}
    â†’ Î“â‰¤ âŠ¢ x â‰¤Ë£ xâ€² â¦‚ Aâ‰¤ 
      ---------------------------
    â†’ Î“â‰¤ â–· Bâ‰¤ âŠ¢ S x â‰¤Ë£ S xâ€² â¦‚ Aâ‰¤

```

## Commuting diagram

```
commuteâ‰¤ : âˆ€ {A B C} (Â±p : A => B) (q : B â‰¤ C) (r : A â‰¤ C) â†’ Set
commuteâ‰¤ (+ p) q r  =  p â¨Ÿ q â‰¡ r
commuteâ‰¤ (- p) q r  =  p â¨Ÿ r â‰¡ q

â‰¤commute : âˆ€ {A B C} (p : A â‰¤ B) (Â±q : B => C) (r : A â‰¤ C) â†’ Set
â‰¤commute p (+ q) r  =  p â¨Ÿ q â‰¡ r
â‰¤commute p (- q) r  =  r â¨Ÿ q â‰¡ p
```

```
commuteâ‰¤áµ‰ : âˆ€ {A B C} (Â±p : A =>áµ‰ B) (q : B â‰¤áµ‰ C) (r : A â‰¤áµ‰ C) â†’ Set
{-
commuteâ‰¤áµ‰ id q r  =  q â‰¡ r
commuteâ‰¤áµ‰ +â˜† q r  =  âŠ¤  -- TODO
commuteâ‰¤áµ‰ -â˜† q r  =  âŠ¤  -- TODO
-}
commuteâ‰¤áµ‰ p q r  =  âŠ¤

â‰¤commuteáµ‰ : âˆ€ {A B C} (p : A â‰¤áµ‰ B) (Â±q : B =>áµ‰ C) (r : A â‰¤áµ‰ C) â†’ Set
â‰¤commuteáµ‰ p q r   =  âŠ¤  -- TODO
```

```
=>á¶œ-returns : âˆ€ {P Q} (Â±q : P =>á¶œ Q) â†’ Typeá¶œ.returns P => Typeá¶œ.returns Q
=>á¶œ-returns (+ âŸ¨ _ âŸ© q) = + q
=>á¶œ-returns (- âŸ¨ _ âŸ© q) = - q

commuteâ‰¤á¶œ : âˆ€ {P Q R} (Â±p : P =>á¶œ Q) (q : Q â‰¤á¶œ R) (r : P â‰¤á¶œ R) â†’ Set
commuteâ‰¤á¶œ Â±p (âŸ¨ _ âŸ© q) (âŸ¨ _ âŸ© r) = commuteâ‰¤ (=>á¶œ-returns Â±p) q r

â‰¤commuteá¶œ : âˆ€ {A B C} (p : A â‰¤á¶œ B) (Â±q : B =>á¶œ C) (r : A â‰¤á¶œ C) â†’ Set
â‰¤commuteá¶œ p (+ q) r  =  p â¨Ÿá¶œ q â‰¡ r
â‰¤commuteá¶œ p (- q) r  =  r â¨Ÿá¶œ q â‰¡ p
```

## Lemmas about commuting diagrams

```
â‰¤returns : âˆ€ {P Q R} {p : P â‰¤á¶œ Q} {Â±q : Q =>á¶œ R} {r : P â‰¤á¶œ R}
  â†’ â‰¤commuteá¶œ p Â±q r â†’ â‰¤commute (_â‰¤á¶œ_.returns p) (=>á¶œ-returns Â±q) (_â‰¤á¶œ_.returns r)
â‰¤returns {Â±q = + _} refl = refl
â‰¤returns {Â±q = - _} refl = refl

pureâ‰¤ : âˆ€ {E A B R} {Â±p : A => B} {q : âŸ¨ E âŸ© B â‰¤á¶œ R} {r : âŸ¨ E âŸ© A â‰¤á¶œ R}
  â†’ commuteâ‰¤ Â±p (_â‰¤á¶œ_.returns q) (_â‰¤á¶œ_.returns r) â†’ commuteâ‰¤á¶œ (pureÂ± Â±p) q r
pureâ‰¤ {Â±p = + _} refl = refl
pureâ‰¤ {Â±p = - _} refl = refl

unique-â‰¤áµ‰ : âˆ€ {E F} {Eâ‰¤ Eâ‰¤â€² : E â‰¤áµ‰ F} â†’ Eâ‰¤ â‰¡ Eâ‰¤â€²
unique-â‰¤áµ‰ {Eâ‰¤ = id} {Eâ‰¤â€² = id} = refl
unique-â‰¤áµ‰ {Eâ‰¤ = Â¡â‰¤â˜†} {Eâ‰¤â€² = Â¡â‰¤â˜†} = refl

â‰¤pure : âˆ€ {E P B C} {p : P â‰¤á¶œ âŸ¨ E âŸ© B} {Â±q : B => C} {r : P â‰¤á¶œ âŸ¨ E âŸ© C}
  â†’ â‰¤commute (_â‰¤á¶œ_.returns p) Â±q (_â‰¤á¶œ_.returns r) â†’ â‰¤commuteá¶œ p (pureÂ± Â±q) r
â‰¤pure {Â±q = + _} refl = congâ‚‚ âŸ¨_âŸ©_ unique-â‰¤áµ‰ refl
â‰¤pure {Â±q = - _} refl = congâ‚‚ âŸ¨_âŸ©_ unique-â‰¤áµ‰ refl

dropâ‡‘ : âˆ€ {A B G} {Â±p : A => B} {q : B â‰¤ G} {r : A â‰¤ G} {g : Ground G}
  â†’ commuteâ‰¤ Â±p (q â‡‘ g) (r â‡‘ g)
    ---------------------------
  â†’ commuteâ‰¤ Â±p q r
dropâ‡‘ {Â±p = + _} refl = refl
dropâ‡‘ {Â±p = - _} refl = refl

identâ‰¤ : âˆ€ {A B} {q r : A â‰¤ B}
  â†’ (Â±p : A => A)
  â†’ split Â±p â‰¡ id
  â†’ commuteâ‰¤ Â±p q r
    -----
  â†’ q â‰¡ r
identâ‰¤ {q = q} (+ id) refl refl rewrite left-id q = refl
identâ‰¤ {r = r} (- id) refl refl rewrite left-id r = refl

â‰¤ident : âˆ€ {A B} {p r : A â‰¤á¶œ B}
  â†’ (Â±q : B =>á¶œ B)
  â†’ splitá¶œ Â±q â‰¡ id
  â†’ â‰¤commuteá¶œ p Â±q r
    -----
  â†’ p â‰¡ r
â‰¤ident (+ âŸ¨ id âŸ© id) refl refl = refl
â‰¤ident (- âŸ¨ id âŸ© id) refl refl = refl

domâ‰¤ :  âˆ€ {A Aâ€² Aâ€³ P Pâ€² Pâ€³}
    {Â±p : A â‡’ P => Aâ€² â‡’ Pâ€²} {q : Aâ€² â‡’ Pâ€² â‰¤ Aâ€³ â‡’ Pâ€³} {r : A â‡’ P â‰¤ Aâ€³ â‡’ Pâ€³}
    {âˆ“s : Aâ€² => A} {Â±t : P =>á¶œ Pâ€²}
  â†’ split Â±p â‰¡ âˆ“s â‡’ Â±t
  â†’ commuteâ‰¤ Â±p q r
    ---------------------------
  â†’ commuteâ‰¤ âˆ“s (dom r) (dom q)
domâ‰¤ {Â±p = + s â‡’ t} {q = q} refl refl = dom-â¨Ÿ (s â‡’ t) q
domâ‰¤ {Â±p = - s â‡’ t} {r = r} refl refl = dom-â¨Ÿ (s â‡’ t) r

codâ‰¤ :  âˆ€ {A Aâ€² Aâ€³ P Pâ€² Pâ€³}
    {Â±p : A â‡’ P => Aâ€² â‡’ Pâ€²} {q : Aâ€² â‡’ Pâ€² â‰¤ Aâ€³ â‡’ Pâ€³} {r : A â‡’ P â‰¤ Aâ€³ â‡’ Pâ€³}
    {âˆ“s : Aâ€² => A} {Â±t : P =>á¶œ Pâ€²}
  â†’ split Â±p â‰¡ âˆ“s â‡’ Â±t
  â†’ commuteâ‰¤ Â±p q r
    ---------------------------
  â†’ commuteâ‰¤á¶œ Â±t (cod q) (cod r)
codâ‰¤ {Â±p = + s â‡’ t} {q = q} refl refl = cong _â‰¤á¶œ_.returns (cod-â¨Ÿ (s â‡’ t) q)
codâ‰¤ {Â±p = - s â‡’ t} {r = r} refl refl = cong _â‰¤á¶œ_.returns (cod-â¨Ÿ (s â‡’ t) r)

â‰¤dom :  âˆ€ {A Aâ€² Aâ€³ B Bâ€² Bâ€³}
    {p : A â‡’ B â‰¤ Aâ€² â‡’ Bâ€²} {Â±q : Aâ€² â‡’ Bâ€² => Aâ€³ â‡’ Bâ€³} {r : A â‡’ B â‰¤ Aâ€³ â‡’ Bâ€³}
    {âˆ“s : Aâ€³ => Aâ€²} {Â±t : Bâ€² =>á¶œ Bâ€³}
  â†’ split Â±q â‰¡ âˆ“s â‡’ Â±t
  â†’ â‰¤commute p Â±q r
    ---------------------------
  â†’ â‰¤commute (dom r) âˆ“s (dom p)
â‰¤dom {p = p} {Â±q = + s â‡’ t} {r = r} refl refl = dom-â¨Ÿ p (s â‡’ t)
â‰¤dom {p = p} {Â±q = - s â‡’ t} {r = r} refl refl = dom-â¨Ÿ r (s â‡’ t)

â‰¤cod :  âˆ€ {A Aâ€² Aâ€³ B Bâ€² Bâ€³}
    {p : A â‡’ B â‰¤ Aâ€² â‡’ Bâ€²} {Â±q : Aâ€² â‡’ Bâ€² => Aâ€³ â‡’ Bâ€³} {r : A â‡’ B â‰¤ Aâ€³ â‡’ Bâ€³}
    {âˆ“s : Aâ€³ => Aâ€²} {Â±t : Bâ€² =>á¶œ Bâ€³}
  â†’ split Â±q â‰¡ âˆ“s â‡’ Â±t
  â†’ â‰¤commute p Â±q r
    ---------------------------
  â†’ â‰¤commuteá¶œ (cod p) Â±t (cod r)
â‰¤cod {p = p} {Â±q = + s â‡’ t} refl refl = cod-â¨Ÿ p (s â‡’ t)
â‰¤cod {Â±q = - s â‡’ t} {r = r} refl refl = cod-â¨Ÿ r (s â‡’ t)
```

## Precision on terms

```
module _ {A B : Set} {F : A â†’ Set} {G : B â†’ Set} (R : âˆ€ {a b} â†’ F a â†’ G b â†’ Set) where

  data Allâ‚‚ : âˆ€ {as bs} â†’ All F as â†’ All G bs â†’ Set where
    [] : Allâ‚‚ [] []
    _âˆ·_ : âˆ€ {a b as bs} {x : F a} {y : G b} {xs : All F as} {ys : All G bs} â†’ R x y â†’ Allâ‚‚ xs ys â†’ Allâ‚‚ (x âˆ· xs) (y âˆ· ys)

module _ {A B : Set} {F : A â†’ Set} {G : B â†’ Set} {R : âˆ€ {a b} â†’ F a â†’ G b â†’ Set} where

  lookup-Allâ‚‚ : âˆ€ {as bs} {xs : All F as} {ys : All G bs} {a}
    â†’ (aâˆˆas : a âˆˆ as)
    â†’ Allâ‚‚ R xs ys
    â†’ Î£[ b âˆˆ B ] Î£[ bâˆˆbs âˆˆ b âˆˆ bs ] R (All.lookup xs aâˆˆas) (All.lookup ys bâˆˆbs)
  lookup-Allâ‚‚ (here refl) (r âˆ· rs) = _ , here refl , r
  lookup-Allâ‚‚ (there aâˆˆas) (r âˆ· rs)
    with lookup-Allâ‚‚ aâˆˆas rs
  ... | _ , bâˆˆbs , r = _ , there bâˆˆbs , r

-- | Specialization of Allâ‚‚ that equates the two underlying lists.
module _ {A : Set} {F G : A â†’ Set} (R : âˆ€ {a} â†’ F a â†’ G a â†’ Set) where
  Allâ‚‚â€² : âˆ€  {as bs} â†’ All F as â†’ All G bs â†’ Set
  Allâ‚‚â€² = Allâ‚‚ Î» {a} {b} x y â†’ Î£ (a â‰¡ b) Î»{ refl â†’ R x y }

module _ {A : Set} â¦ƒ DecEq-A : DecEq A â¦„ {F G : A â†’ Set} {R : âˆ€ {a} â†’ F a â†’ G a â†’ Set} where
  open import Data.Fin.Base using (toâ„•)
  open import Data.Nat.Properties using (suc-injective)

  lookup-Allâ‚‚â€²-index : âˆ€ {as bs} {xs : All F as} {ys : All G bs} {a}
      â†’ (aâˆˆas : a âˆˆ as)
      â†’ (rs : Allâ‚‚â€² R xs ys)
      â†’ let b , bâˆˆbs , _ = lookup-Allâ‚‚ aâˆˆas rs in
        toâ„• (Any.index aâˆˆas) â‰¡ toâ„• (Any.index bâˆˆbs)
  lookup-Allâ‚‚â€²-index (here refl) (_âˆ·_ (refl , r) rs) = refl
  lookup-Allâ‚‚â€²-index (there aâˆˆas) (_âˆ·_ (refl , r) rs)
    = cong suc (lookup-Allâ‚‚â€²-index aâˆˆas rs)

  idem-index : âˆ€ {as} {a : A} {aâˆˆas aâˆˆasâ€² : a âˆˆ as} â†’ toâ„• (Any.index aâˆˆas) â‰¡ toâ„• (Any.index aâˆˆasâ€²) â†’ aâˆˆas â‰¡ aâˆˆasâ€²
  idem-index {aâˆˆas = here refl} {aâˆˆasâ€² = here refl} _ = refl
  idem-index {aâˆˆas = there aâˆˆas} {aâˆˆasâ€² = there aâˆˆasâ€²} suc-eq = cong there (idem-index (suc-injective suc-eq))

  Allâ‚‚â€²-â‰¡ : âˆ€ {as bs} {xs : All F as} {ys : All G bs} â†’ Allâ‚‚â€² R xs ys â†’ as â‰¡ bs
  Allâ‚‚â€²-â‰¡ [] = refl
  Allâ‚‚â€²-â‰¡ ((refl , _) âˆ· rs) with Allâ‚‚â€²-â‰¡ rs
  ... | refl = refl

  lookup-Allâ‚‚â€²-âˆˆ? : âˆ€ {as bs} {xs : All F as} {ys : All G bs} {a}
      â†’ {aâˆˆas : a âˆˆ as}
      â†’ (rs : Allâ‚‚â€² R xs ys)
      â†’ let b , bâˆˆbs , _ = lookup-Allâ‚‚ aâˆˆas rs in
        (a âˆˆ? as) â‰¡ yes aâˆˆas â†’ (b âˆˆ? bs) â‰¡ yes bâˆˆbs
  lookup-Allâ‚‚â€²-âˆˆ? {aâˆˆas = aâˆˆas} rs eq with Allâ‚‚â€²-â‰¡ rs | lookup-Allâ‚‚ aâˆˆas rs | lookup-Allâ‚‚â€²-index aâˆˆas rs
  ... | refl | _ , _ , refl , _ | eqâ€² = trans eq (cong yes (idem-index eqâ€²))

  lookup-Allâ‚‚â€² : âˆ€ {as bs} {xs : All F as} {ys : All G bs} {a}
    â†’ {aâˆˆas : a âˆˆ as}
    â†’ Allâ‚‚â€² R xs ys
    â†’ (a âˆˆ? as) â‰¡ yes aâˆˆas
    â†’ Î£[ aâˆˆbs âˆˆ a âˆˆ bs ] (a âˆˆ? bs) â‰¡ yes aâˆˆbs Ã— R (All.lookup xs aâˆˆas) (All.lookup ys aâˆˆbs)
  lookup-Allâ‚‚â€² {aâˆˆas = aâˆˆas} rs eq with lookup-Allâ‚‚ aâˆˆas rs | lookup-Allâ‚‚â€²-âˆˆ? rs eq
  ... | _ , aâˆˆbs , refl , r | eqâ€² = aâˆˆbs , eqâ€² , r
```

```
infix 3 _âŠ¢_â‰¤á´¹_â¦‚_ _âŠ¢_â‰¤_â¦‚_â¡_

record _âŠ¢_â‰¤_â¦‚_â¡_ {Î“ Î“â€²} (Î“â‰¤ : Î“ â‰¤á´³ Î“â€²) {P Pâ€² Q Qâ€²} (H : Î“ âŠ¢ P â¡ Q) (Hâ€² : Î“â€² âŠ¢ Pâ€² â¡ Qâ€²) (Pâ‰¤ : P â‰¤á¶œ Pâ€²) (Qâ‰¤ : Q â‰¤á¶œ Qâ€²) : Set

data _âŠ¢_â‰¤á´¹_â¦‚_ {Î“ Î“â€²} (Î“â‰¤ : Î“ â‰¤á´³ Î“â€²) : âˆ€ {A Aâ€²} â†’ Î“ âŠ¢ A â†’ Î“â€² âŠ¢ Aâ€² â†’ A â‰¤á¶œ Aâ€² â†’ Set where

  `â‰¤` : âˆ€ {A Aâ€² x xâ€² E Eâ€²} {páµ‰ : E â‰¤áµ‰ Eâ€²} {p : A â‰¤ Aâ€²}
    â†’ Î“â‰¤ âŠ¢ x â‰¤Ë£ xâ€² â¦‚ p
      --------------------
    â†’ Î“â‰¤ âŠ¢ ` x â‰¤á´¹ ` xâ€² â¦‚ âŸ¨ páµ‰ âŸ© p

  Æ›â‰¤Æ› : âˆ€ {E Eâ€² A Aâ€² B Bâ€² N Nâ€²} {páµ‰ : E â‰¤áµ‰ Eâ€²} {p : A â‡’ B â‰¤ Aâ€² â‡’ Bâ€²}
    â†’ Î“â‰¤ â–· dom p âŠ¢ N â‰¤á´¹ Nâ€² â¦‚ cod p
      ----------------------------
    â†’ Î“â‰¤ âŠ¢ Æ› N â‰¤á´¹ Æ› Nâ€² â¦‚ âŸ¨ páµ‰ âŸ© p

  Â·â‰¤Â· : âˆ€ {A Aâ€² E Eâ€² B Bâ€² L Lâ€² M Mâ€²} {p : A â‡’ âŸ¨ E âŸ© B â‰¤ Aâ€² â‡’ âŸ¨ Eâ€² âŸ© Bâ€²} 
      (let qáµ‰ = _â‰¤á¶œ_.effects (cod p))
    â†’ Î“â‰¤ âŠ¢ L â‰¤á´¹ Lâ€² â¦‚ âŸ¨ qáµ‰ âŸ© p
    â†’ Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ âŸ¨ qáµ‰ âŸ© dom p
      -----------------------------
    â†’ Î“â‰¤ âŠ¢ L Â· M â‰¤á´¹ Lâ€² Â· Mâ€² â¦‚ cod p

  $â‰¤$ : âˆ€ {Î¹ E Eâ€²} {páµ‰ : E â‰¤áµ‰ Eâ€²}
    â†’ (k : rep Î¹)
      ------------------------
    â†’ Î“â‰¤ âŠ¢ $ k â‰¤á´¹ $ k â¦‚ âŸ¨ páµ‰ âŸ© id

  â¦…â¦†â‰¤â¦…â¦† : âˆ€ {Î¹ Î¹â€² Î¹â€³ E Eâ€² M Mâ€² N Nâ€²} {páµ‰ : E â‰¤áµ‰ Eâ€²}
    â†’ (_âŠ•_ : rep Î¹ â†’ rep Î¹â€² â†’ rep Î¹â€³)
    â†’ Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ âŸ¨ páµ‰ âŸ© id
    â†’ Î“â‰¤ âŠ¢ N â‰¤á´¹ Nâ€² â¦‚ âŸ¨ páµ‰ âŸ© id
      -------------------------------------
    â†’ Î“â‰¤ âŠ¢ M â¦… _âŠ•_ â¦† N â‰¤á´¹ Mâ€² â¦… _âŠ•_ â¦† Nâ€² â¦‚ âŸ¨ páµ‰ âŸ© id
    
  â‡‘â‰¤â‡‘ : âˆ€ {G E Eâ€² M Mâ€²} {páµ‰ : E â‰¤áµ‰ Eâ€²}
    â†’ (g : Ground G)
    â†’ Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ âŸ¨ páµ‰ âŸ© id
      -----------------------------
    â†’ Î“â‰¤ âŠ¢ (M â‡‘ g) â‰¤á´¹ (Mâ€² â‡‘ g) â¦‚ âŸ¨ páµ‰ âŸ© id

  â‰¤â‡‘ : âˆ€ {A G E Eâ€² M Mâ€²} {p : A â‰¤ G} {páµ‰ : E â‰¤áµ‰ Eâ€²}
    â†’ (g : Ground G)
    â†’ Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ âŸ¨ páµ‰ âŸ© p
      --------------------------
    â†’ Î“â‰¤ âŠ¢ M â‰¤á´¹ (Mâ€² â‡‘ g) â¦‚ âŸ¨ páµ‰ âŸ© (p â‡‘ g)

  castâ‰¤ : âˆ€ {A B C} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ C}
          {Â±p : A =>á¶œ B} {q : B â‰¤á¶œ C} {r : A â‰¤á¶œ C}
    â†’ commuteâ‰¤á¶œ Â±p q r
    â†’ Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ r
      -------------------------
    â†’ Î“â‰¤ âŠ¢ cast Â±p M â‰¤á´¹ Mâ€² â¦‚ q

  â‰¤cast : âˆ€ {A B C} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ B}
          {p : A â‰¤á¶œ B} {Â±q : B =>á¶œ C} {r : A â‰¤á¶œ C}
    â†’ â‰¤commuteá¶œ p Â±q r
    â†’ Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ p
      -------------------------
    â†’ Î“â‰¤ âŠ¢ M â‰¤á´¹ cast Â±q Mâ€² â¦‚ r

  blameâ‰¤ : âˆ€ {A Aâ€² Mâ€²} {p : A â‰¤á¶œ Aâ€²}
      ---------------------
    â†’ Î“â‰¤ âŠ¢ blame â‰¤á´¹ Mâ€² â¦‚ p

  wrapâ‰¤ : âˆ€ {A Aâ€² Aâ€³ B Bâ€² Bâ€³ E Eâ€²}
             {N : Î“ â–· A âŠ¢ B} {Nâ€² : Î“â€² â–· Aâ€³ âŠ¢ Bâ€³}
             {Eâ‰¤ : E â‰¤áµ‰ Eâ€²}
             {Â±p : A â‡’ B => Aâ€² â‡’ Bâ€²} {q : Aâ€² â‡’ Bâ€² â‰¤ Aâ€³ â‡’ Bâ€³} {r : A â‡’ B â‰¤ Aâ€³ â‡’ Bâ€³}
             {âˆ“s : Aâ€² => A} {Â±t : B =>á¶œ Bâ€²}
    â†’ split Â±p â‰¡ âˆ“s â‡’ Â±t
    â†’ commuteâ‰¤ Â±p q r
    â†’ (âˆ€ {F Fâ€²} {Fâ‰¤ : F â‰¤áµ‰ Fâ€²} â†’ Î“â‰¤ âŠ¢ Æ› N â‰¤á´¹ Æ› Nâ€² â¦‚ âŸ¨ Fâ‰¤ âŸ© r)
      -----------------------------------------------------
    â†’ Î“â‰¤ âŠ¢ Æ›-wrap âˆ“s Â±t (Æ› N) â‰¤á´¹ Æ› Nâ€² â¦‚ âŸ¨ Eâ‰¤ âŸ© q

  â‰¤wrap : âˆ€ {A Aâ€² Aâ€³ B Bâ€² Bâ€³ E Eâ€²}
             {N : Î“ â–· A âŠ¢ B} {Nâ€² : Î“â€² â–· Aâ€² âŠ¢ Bâ€²}
             {Eâ‰¤ : E â‰¤áµ‰ Eâ€²}
             {p : A â‡’ B â‰¤ Aâ€² â‡’ Bâ€²} {Â±q : Aâ€² â‡’ Bâ€² => Aâ€³ â‡’ Bâ€³} {r : A â‡’ B â‰¤ Aâ€³ â‡’ Bâ€³}
             {âˆ“s : Aâ€³ => Aâ€²} {Â±t : Bâ€² =>á¶œ Bâ€³}
    â†’ split Â±q â‰¡ âˆ“s â‡’ Â±t
    â†’ â‰¤commute p Â±q r
    â†’ (âˆ€ {F Fâ€²} {Fâ‰¤ : F â‰¤áµ‰ Fâ€²} â†’ Î“â‰¤ âŠ¢ Æ› N â‰¤á´¹ Æ› Nâ€² â¦‚ âŸ¨ Fâ‰¤ âŸ© p)
      -----------------------------------------------------
    â†’ Î“â‰¤ âŠ¢ Æ› N â‰¤á´¹ Æ›-wrap âˆ“s Â±t (Æ› Nâ€²) â¦‚ âŸ¨ Eâ‰¤ âŸ© r

  performâ‰¤perform : âˆ€ {E Eâ€² e} {eâˆˆE : e âˆˆâ˜† E} {eâˆˆEâ€² : e âˆˆâ˜† Eâ€²} {A}
                      {Eâ‰¤ : E â‰¤áµ‰ Eâ€²} {M Mâ€²}
    â†’ {eq : response e â‰¡ A}
    â†’ Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ âŸ¨ Eâ‰¤ âŸ© id
    â†’ Î“â‰¤ âŠ¢ perform- eâˆˆE eq M â‰¤á´¹ perform- eâˆˆEâ€² eq Mâ€² â¦‚ âŸ¨ Eâ‰¤ âŸ© id

  handleâ‰¤handle : âˆ€ {P Pâ€² Q Qâ€²} {Pâ‰¤ : P â‰¤á¶œ Pâ€²} {Qâ‰¤ : Q â‰¤á¶œ Qâ€²} {H Hâ€² M Mâ€²}
    â†’ Î“â‰¤ âŠ¢ H â‰¤ Hâ€² â¦‚ Pâ‰¤ â¡ Qâ‰¤
    â†’ Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ Pâ‰¤
    â†’ Î“â‰¤ âŠ¢ handle H M â‰¤á´¹ handle Hâ€² Mâ€² â¦‚ Qâ‰¤

On-Perform : âˆ€ {Î“ Î“â€²} (Î“â‰¤ : Î“ â‰¤á´³ Î“â€²) {Q Qâ€²} (Qâ‰¤ : Q â‰¤á¶œ Qâ€²) â†’ âˆ€ {Eh Ehâ€²}
  â†’ Core.On-Perform Î“ Q Eh â†’ Core.On-Perform Î“â€² Qâ€² Ehâ€² â†’ Set
On-Perform Î“â‰¤ Qâ‰¤ = Allâ‚‚â€² Î» M Mâ€² â†’ âˆƒ[ Bâ‡’Qâ‰¤ ] dom Bâ‡’Qâ‰¤ â‰¡ id Ã— cod Bâ‡’Qâ‰¤ â‰¡ Qâ‰¤ Ã— (Î“â‰¤ â–· id â–· (Bâ‡’Qâ‰¤) âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ Qâ‰¤)

record _âŠ¢_â‰¤_â¦‚_â¡_ Î“â‰¤ {P Pâ€² Q Qâ€²} H Hâ€² Pâ‰¤ Qâ‰¤ where
  inductive
  open _â‰¤á¶œ_ using (returns)
  field
    on-return : Î“â‰¤ â–· returns Pâ‰¤ âŠ¢ on-return H â‰¤á´¹ on-return Hâ€² â¦‚ Qâ‰¤
    on-perform : On-Perform Î“â‰¤ Qâ‰¤ (on-perform H) (on-perform Hâ€²)

open _âŠ¢_â‰¤_â¦‚_â¡_ public
```

```
generalize-Æ›â‰¤Æ› : âˆ€ {Î“ Î“â€²} {Î“â‰¤ : Î“ â‰¤á´³ Î“â€²} {A Aâ€²} {P Pâ€²} {p : A â‡’ P â‰¤ Aâ€² â‡’ Pâ€²} {N : Î“ â–· A âŠ¢ P} {Nâ€²}
  â†’ âˆ€ {E Eâ€² F Fâ€²} {Eâ‰¤ : E â‰¤áµ‰ Eâ€²} {Fâ‰¤ : F â‰¤áµ‰ Fâ€²}
  â†’ Î“â‰¤ âŠ¢ (Æ› N) â‰¤á´¹ (Æ› Nâ€²) â¦‚ âŸ¨ Eâ‰¤ âŸ© p
  â†’ Î“â‰¤ âŠ¢ (Æ› N) â‰¤á´¹ (Æ› Nâ€²) â¦‚ âŸ¨ Fâ‰¤ âŸ© p
generalize-Æ›â‰¤Æ› (Æ›â‰¤Æ› Nâ‰¤Nâ€²) = Æ›â‰¤Æ› Nâ‰¤Nâ€²
generalize-Æ›â‰¤Æ› (wrapâ‰¤ i e Nâ‰¤Nâ€²) = wrapâ‰¤ i e Nâ‰¤Nâ€²
generalize-Æ›â‰¤Æ› (â‰¤wrap i e Nâ‰¤Nâ€²) = â‰¤wrap i e Nâ‰¤Nâ€²
```

## Upcast congruence

```
{-
data _=>_âˆ‹_â‰¤_ : âˆ€ {P Pâ€² Q Qâ€²} â†’ P â‰¤á¶œ Pâ€² â†’ Q â‰¤á¶œ Qâ€² â†’ P =>áµ‰áµ› Q â†’ Pâ€² =>áµ‰áµ› Qâ€² â†’ Set where
  -- _â‰¤+áµ›_ :
  --   (Aâ‰¤ : A â‰¤ B) â†’ (Aâ€²â‰¤ : Aâ€² â‰¤ Bâ€²) â†’ (âŸ¨-âŸ©_ {E = E} (+ Aâ‰¤)) â‰¤áµ âŸ¨-âŸ©_ {E = Eâ€²} (+ Aâ€²â‰¤)
  -- _â‰¤-áµ›_ :
  --   (Bâ‰¤ : B â‰¤ A) â†’ (Bâ€²â‰¤ : Bâ€² â‰¤ Aâ€²) â†’ (âŸ¨-âŸ©_ {E = E} (- Bâ‰¤)) â‰¤áµ âŸ¨-âŸ©_ {E = Eâ€²} (- Bâ€²â‰¤)
  +áµ‰ :
      (Eâ‰¤F : E â‰¤áµ‰ F) â†’ (Eâ€²â‰¤Fâ€² : Eâ€² â‰¤áµ‰ Fâ€²)
    â†’ (âŸ¨ Eâ‰¤ âŸ© Aâ‰¤) => (âŸ¨ Fâ‰¤ âŸ© Aâ‰¤) âˆ‹ âŸ¨_âŸ©- (+ Eâ‰¤F) â‰¤ âŸ¨_âŸ©- (+ Eâ€²â‰¤Fâ€²)
  -áµ‰ :
      (Fâ‰¤E : F â‰¤áµ‰ E) â†’ (Fâ€²â‰¤Eâ€² : Fâ€² â‰¤áµ‰ Eâ€²) â†’ (âŸ¨ Eâ‰¤ âŸ© Aâ‰¤) => (âŸ¨ Fâ‰¤ âŸ© Aâ‰¤) âˆ‹ âŸ¨_âŸ©- (- Fâ‰¤E) â‰¤ âŸ¨_âŸ©- (- Fâ€²â‰¤Eâ€²)
-}
```

```
+â‰¤+ : âˆ€ {Î“ Î“â€² A B Aâ€² Bâ€²} {M : Î“ âŠ¢ A} {Mâ€² : Î“â€² âŠ¢ Aâ€²} {Î“â‰¤ : Î“ â‰¤á´³ Î“â€²}
    {p : A â‰¤á¶œ B} {q : Aâ€² â‰¤á¶œ Bâ€²} {s : A â‰¤á¶œ Aâ€²} {t : B â‰¤á¶œ Bâ€²}
  â†’ p â¨Ÿá¶œ t â‰¡ s â¨Ÿá¶œ q
  â†’ Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ s
    ------------------------------------
  â†’ Î“â‰¤ âŠ¢ cast (+ p) M â‰¤á´¹ cast (+ q) Mâ€² â¦‚ t
+â‰¤+ e Mâ‰¤Mâ€² = castâ‰¤ (cong _â‰¤á¶œ_.returns e) (â‰¤cast refl Mâ‰¤Mâ€²)
```

Here is the derivation:

    Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ s
    s â¨Ÿ q â‰¡ r
    ---------------------- â‰¤+
    Î“â‰¤ âŠ¢ M â‰¤á´¹ (Mâ€² + q) â¦‚ r
    p â¨Ÿ t â‰¡ r
    ---------------------------- +â‰¤
    Î“â‰¤ âŠ¢ (M + p) â‰¤á´¹ (Mâ€² + q) â¦‚ t

Here it is illustrated:

                   s
         M : A    ---â†’    Mâ€² : Aâ€²
           |       \         |
         p |      r \        | q
           -         â†˜       -
      (M + p) : B ---â†’ (Mâ€² + q) : Bâ€²
                   t


## Downcast congruence

```
-â‰¤- : âˆ€ {Î“ Î“â€² A B Aâ€² Bâ€²} {M : Î“ âŠ¢ B} {Mâ€² : Î“â€² âŠ¢ Bâ€²} {Î“â‰¤ : Î“ â‰¤á´³ Î“â€²}
    {p : A â‰¤á¶œ B} {q : Aâ€² â‰¤á¶œ Bâ€²} {s : A â‰¤á¶œ Aâ€²} {t : B â‰¤á¶œ Bâ€²}
  â†’ s â¨Ÿá¶œ q â‰¡ p â¨Ÿá¶œ t
  â†’ Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ t
    ------------------------------------
  â†’ Î“â‰¤ âŠ¢ cast (- p) M â‰¤á´¹ cast (- q) Mâ€² â¦‚ s
-â‰¤- e Mâ‰¤Mâ€² = â‰¤cast e (castâ‰¤ refl Mâ‰¤Mâ€²)
```

Here is the derivation:

    Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ t
    p â¨Ÿ t â‰¡ r
    ---------------------- â‰¤+
    Î“â‰¤ âŠ¢ (M - p) â‰¤á´¹ Mâ€² â¦‚ r
    s â¨Ÿ q â‰¡ r
    ---------------------------- +â‰¤
    Î“â‰¤ âŠ¢ (M - p) â‰¤á´¹ (Mâ€² - q) â¦‚ t

Here it is illustrated:

                   s
         M : A    ---â†’    Mâ€² : Aâ€²
           |       \         |
         p |      r \        | q
           -         â†˜       -
      (M + p) : B ---â†’ (Mâ€² + q) : Bâ€²
                   t

## Effect cast congruence

```
{-
=>-â‰¤ : âˆ€ {M : Î“ âŠ¢ P} {Mâ€² : Î“â€² âŠ¢ Pâ€²} {P=>Q Pâ€²=>Qâ€²}
  â†’ Pâ‰¤ => Qâ‰¤ âˆ‹ P=>Q â‰¤ Pâ€²=>Qâ€²
  â†’ Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ Pâ‰¤
    ------------------------------------
  â†’ Î“â‰¤ âŠ¢ (M castâŸ¨âŸ© P=>Q) â‰¤á´¹ (Mâ€² castâŸ¨âŸ© Pâ€²=>Qâ€²) â¦‚ Qâ‰¤
=>-â‰¤ (+áµ‰ {Fâ‰¤ = Fâ‰¤} Eâ‰¤F Eâ€²â‰¤Fâ€²) Mâ‰¤Mâ€² = âŸ¨âŸ©â‰¤ {Fâ‰¤ = Eâ‰¤F â¨Ÿáµ‰ Fâ‰¤} (â‰¤âŸ¨âŸ© Mâ‰¤Mâ€²)
=>-â‰¤ (-áµ‰ {Eâ‰¤ = Eâ‰¤} Fâ‰¤E Fâ€²â‰¤Eâ€²) Mâ‰¤Mâ€² = â‰¤âŸ¨âŸ© {Fâ‰¤ = Fâ‰¤E â¨Ÿáµ‰ Eâ‰¤} (âŸ¨âŸ©â‰¤ Mâ‰¤Mâ€²)
-}
```

## Reflexivity of term precision

```
reflË£ : âˆ€ {Î“ A}
    â†’ (x : Î“ âˆ‹ A)
      -------------------
    â†’ idá´³ âŠ¢ x â‰¤Ë£ x â¦‚ id
reflË£ Z      =  Zâ‰¤Z
reflË£ (S x)  =  Sâ‰¤S (reflË£ x)

reflÊ° : âˆ€ {Î“ P Q}
  â†’ (H : Î“ âŠ¢ P â¡ Q)
  â†’ idá´³ âŠ¢ H â‰¤ H â¦‚ âŸ¨ id âŸ© id â¡ âŸ¨ id âŸ© id

reflá´¹ : âˆ€ {Î“ P}
    â†’ (M : Î“ âŠ¢ P)
      -------------------
    â†’ idá´³ âŠ¢ M â‰¤á´¹ M â¦‚ âŸ¨ id âŸ© id
reflá´¹ (` x)           =  `â‰¤` (reflË£ x)
reflá´¹ (Æ› M)           =  Æ›â‰¤Æ› (reflá´¹ M)
reflá´¹ (L Â· M)         =  Â·â‰¤Â· (reflá´¹ L) (reflá´¹ M)
reflá´¹ ($ k)           =  $â‰¤$ k
reflá´¹ (M â¦… _âŠ•_ â¦† N)   =  â¦…â¦†â‰¤â¦…â¦† _âŠ•_ (reflá´¹ M) (reflá´¹ N)
reflá´¹ (M â‡‘ g)         =  â‡‘â‰¤â‡‘ g (reflá´¹ M)
reflá´¹ (cast (+ p) M)  =  +â‰¤+ (sym (left-idá¶œ p)) (reflá´¹ M)
reflá´¹ (cast (- p) M)  =  -â‰¤- (left-idá¶œ p) (reflá´¹ M)
reflá´¹ blame           =  blameâ‰¤
reflá´¹ (perform- eâˆˆE eq M) = performâ‰¤perform (reflá´¹ M)
reflá´¹ (handle H M) = handleâ‰¤handle (reflÊ° H) (reflá´¹ M)

reflÊ° H = record
  { on-return = reflá´¹ (H .on-return)
  ; on-perform = refl-on-perform (H .on-perform) }
  where
    refl-on-perform : âˆ€ {Eh} Ms â†’ On-Perform _ _ {Eh = Eh} Ms Ms
    refl-on-perform [] = []
    refl-on-perform (M âˆ· Ms) = (refl , id , refl , refl , reflá´¹ M) âˆ· refl-on-perform Ms
```

## Renaming {#renaming-prec}

Precision on renamings

```
infix 4 _â†’á´¿_âˆ‹_â‰¤_ _â†’Ë¢_âˆ‹_â‰¤_ _â†’áµ€_âˆ‹_â‰¤_

_â†’á´¿_âˆ‹_â‰¤_ : âˆ€ {Î“ Î“â€² Î” Î”â€²} (Î“â‰¤ : Î“ â‰¤á´³ Î“â€²) (Î”â‰¤ : Î” â‰¤á´³ Î”â€²) â†’ (Î“ â†’á´¿ Î”) â†’ (Î“â€² â†’á´¿ Î”â€²) â†’ Set
Î“â‰¤ â†’á´¿ Î”â‰¤ âˆ‹ Ï â‰¤ Ïâ€² = âˆ€ {A Aâ€²} {Aâ‰¤ : A â‰¤ Aâ€²} {x xâ€²}
  â†’ Î“â‰¤ âŠ¢ x â‰¤Ë£ xâ€² â¦‚ Aâ‰¤
    -----------------------
  â†’ Î”â‰¤ âŠ¢ Ï x â‰¤Ë£ Ïâ€² xâ€² â¦‚ Aâ‰¤

_â†’Ë¢_âˆ‹_â‰¤_ : âˆ€ {Î“ Î“â€² Î” Î”â€²} (Î“â‰¤ : Î“ â‰¤á´³ Î“â€²) (Î”â‰¤ : Î” â‰¤á´³ Î”â€²) â†’ (Î“ â†’Ë¢ Î”) â†’ (Î“â€² â†’Ë¢ Î”â€²) â†’ Set
Î“â‰¤ â†’Ë¢ Î”â‰¤ âˆ‹ Ïƒ â‰¤ Ïƒâ€² = âˆ€ {A Aâ€²} {Aâ‰¤ : A â‰¤ Aâ€²} {E Eâ€²} {Eâ‰¤ : E â‰¤áµ‰ Eâ€²} {x xâ€²}
  â†’ Î“â‰¤ âŠ¢ x â‰¤Ë£ xâ€² â¦‚ Aâ‰¤
    -----------------------
  â†’ Î”â‰¤ âŠ¢ Ïƒ x â‰¤á´¹ Ïƒâ€² xâ€² â¦‚ âŸ¨ Eâ‰¤ âŸ© Aâ‰¤

_â†’áµ€_âˆ‹_â‰¤_ : âˆ€ {Î“ Î“â€² Î” Î”â€²} (Î“â‰¤ : Î“ â‰¤á´³ Î“â€²) (Î”â‰¤ : Î” â‰¤á´³ Î”â€²) â†’ (Î“ â†’áµ€ Î”) â†’ (Î“â€² â†’áµ€ Î”â€²) â†’ Set
Î“â‰¤ â†’áµ€ Î”â‰¤ âˆ‹ s â‰¤ sâ€² = âˆ€ {A Aâ€²} {Aâ‰¤ : A â‰¤ Aâ€²} {E Eâ€²} {Eâ‰¤ : E â‰¤áµ‰ Eâ€²} {M Mâ€²}
  â†’ Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ âŸ¨ Eâ‰¤ âŸ© Aâ‰¤
    -----------------------
  â†’ Î”â‰¤ âŠ¢ s M â‰¤á´¹ sâ€² Mâ€² â¦‚ âŸ¨ Eâ‰¤ âŸ© Aâ‰¤
```

Extension
```
renâ–·â‰¤ : âˆ€ {Î“ Î“â€² Î” Î”â€²} {Î“â‰¤ : Î“ â‰¤á´³ Î“â€²} {Î”â‰¤ : Î” â‰¤á´³ Î”â€²} {Ï : Î“ â†’á´¿ Î”} {Ïâ€² : Î“â€² â†’á´¿ Î”â€²}
  â†’ Î“â‰¤ â†’á´¿ Î”â‰¤ âˆ‹ Ï â‰¤ Ïâ€²
    ------------------------------------------------------
  â†’ âˆ€ {A Aâ€²} {Aâ‰¤ : A â‰¤ Aâ€²} â†’ Î“â‰¤ â–· Aâ‰¤ â†’á´¿ Î”â‰¤ â–· Aâ‰¤ âˆ‹ renâ–· Ï â‰¤ renâ–· Ïâ€²
renâ–·â‰¤ Ïâ‰¤ Zâ‰¤Z       =  Zâ‰¤Z
renâ–·â‰¤ Ïâ‰¤ (Sâ‰¤S xâ‰¤)  =  Sâ‰¤S (Ïâ‰¤ xâ‰¤)
```

```
renâˆ˜Æ›-wrap : âˆ€ {Î“ Î” A Aâ€² P Pâ€² E} {âˆ“s : Aâ€² => A} {Â±t : P =>á¶œ Pâ€²}
    (Ï : Î“ â†’á´¿ Î”) (M : âˆ€ {E} â†’ Î“ âŠ¢ âŸ¨ E âŸ© (A â‡’ P))
  â†’ ren Ï (Æ›-wrap âˆ“s Â±t M {E = E}) â‰¡ Æ›-wrap âˆ“s Â±t (ren Ï M)
renâˆ˜Æ›-wrap {Aâ€² = Aâ€²} {P = âŸ¨ E âŸ© _} {âˆ“s = âˆ“s} {Â±t} Ï M
  rewrite (liftâˆ˜ren {A = Aâ€²} Ï (M {E = E})) = refl

subâˆ˜Æ›-wrap : âˆ€ {Î“ Î” A Aâ€² P Pâ€² E} {âˆ“s : Aâ€² => A} {Â±t : P =>á¶œ Pâ€²}
    (Ïƒ : Î“ â†’Ë¢ Î”) (M : âˆ€ {E} â†’ Î“ âŠ¢ âŸ¨ E âŸ© (A â‡’ P))
  â†’ sub Ïƒ (Æ›-wrap âˆ“s Â±t M {E = E}) â‰¡ Æ›-wrap âˆ“s Â±t (sub Ïƒ M)
subâˆ˜Æ›-wrap {Aâ€² = Aâ€²} {P = âŸ¨ E âŸ© _} {âˆ“s = âˆ“s} {Â±t} Ïƒ M
  rewrite (liftâˆ˜sub {A = Aâ€²} Ïƒ (M {E = E})) = refl
```

Preservation of precision under renaming
```
renâ‰¤Ê° : âˆ€ {Î“ Î“â€² Î” Î”â€²} {Î“â‰¤ : Î“ â‰¤á´³ Î“â€²} {Î”â‰¤ : Î” â‰¤á´³ Î”â€²} {Ï : Î“ â†’á´¿ Î”} {Ïâ€² : Î“â€² â†’á´¿ Î”â€²} 
  â†’ Î“â‰¤ â†’á´¿ Î”â‰¤ âˆ‹ Ï â‰¤ Ïâ€²
    -------------------------------------------
  â†’ (âˆ€ {P Pâ€² Q Qâ€²} {Pâ‰¤ : P â‰¤á¶œ Pâ€²} {Qâ‰¤ : Q â‰¤á¶œ Qâ€²} {H Hâ€²}
      â†’ Î“â‰¤ âŠ¢ H â‰¤ Hâ€² â¦‚ Pâ‰¤ â¡ Qâ‰¤
      â†’ Î”â‰¤ âŠ¢ renÊ° Ï H â‰¤ renÊ° Ïâ€² Hâ€² â¦‚ Pâ‰¤ â¡ Qâ‰¤)

renâ‰¤ : âˆ€ {Î“ Î“â€² Î” Î”â€²} {Î“â‰¤ : Î“ â‰¤á´³ Î“â€²} {Î”â‰¤ : Î” â‰¤á´³ Î”â€²} {Ï : Î“ â†’á´¿ Î”} {Ïâ€² : Î“â€² â†’á´¿ Î”â€²} 
  â†’  Î“â‰¤ â†’á´¿ Î”â‰¤ âˆ‹ Ï â‰¤ Ïâ€²
    -------------------------------------------
  â†’ (âˆ€ {A Aâ€²} {Aâ‰¤ : A â‰¤ Aâ€²} {E Eâ€²} {Eâ‰¤ : E â‰¤áµ‰ Eâ€²} {M Mâ€²}
      â†’ Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ âŸ¨ Eâ‰¤ âŸ© Aâ‰¤
      â†’ Î”â‰¤ âŠ¢ ren Ï M â‰¤á´¹ ren Ïâ€² Mâ€² â¦‚ âŸ¨ Eâ‰¤ âŸ© Aâ‰¤)
renâ‰¤ Ïâ‰¤ (`â‰¤` x)              =  `â‰¤` (Ïâ‰¤ x)
renâ‰¤ Ïâ‰¤ (Æ›â‰¤Æ› Nâ‰¤)             =  Æ›â‰¤Æ› (renâ‰¤ (renâ–·â‰¤ Ïâ‰¤) Nâ‰¤)
renâ‰¤ Ïâ‰¤ (Â·â‰¤Â· Lâ‰¤ Mâ‰¤)          =  Â·â‰¤Â· (renâ‰¤ Ïâ‰¤ Lâ‰¤) (renâ‰¤ Ïâ‰¤ Mâ‰¤)
renâ‰¤ Ïâ‰¤ ($â‰¤$ k)              =  $â‰¤$ k
renâ‰¤ Ïâ‰¤ (â¦…â¦†â‰¤â¦…â¦† _âŠ•_ Mâ‰¤ Nâ‰¤)     =  â¦…â¦†â‰¤â¦…â¦† _âŠ•_ (renâ‰¤ Ïâ‰¤ Mâ‰¤) (renâ‰¤ Ïâ‰¤ Nâ‰¤) 
renâ‰¤ Ïâ‰¤ (â‡‘â‰¤â‡‘ g Mâ‰¤)           =  â‡‘â‰¤â‡‘ g (renâ‰¤ Ïâ‰¤ Mâ‰¤)
renâ‰¤ Ïâ‰¤ (â‰¤â‡‘ g Mâ‰¤)            =  â‰¤â‡‘ g (renâ‰¤ Ïâ‰¤ Mâ‰¤)
renâ‰¤ Ïâ‰¤ (castâ‰¤ e Mâ‰¤)           =  castâ‰¤ e (renâ‰¤ Ïâ‰¤ Mâ‰¤)
renâ‰¤ Ïâ‰¤ (â‰¤cast e Mâ‰¤)           =  â‰¤cast e (renâ‰¤ Ïâ‰¤ Mâ‰¤)
renâ‰¤ Ïâ‰¤ blameâ‰¤               =  blameâ‰¤
renâ‰¤ {Ï = Ï} Ïâ‰¤ {Aâ‰¤ = Aâ‰¤} {E = E}
  (wrapâ‰¤ {N = N} {âˆ“s = âˆ“s} {Â±t} i e Æ›Nâ‰¤Æ›Nâ€²)
  rewrite renâˆ˜Æ›-wrap {E = E} {âˆ“s = âˆ“s} {Â±t = Â±t} Ï (Æ› N)
  = wrapâ‰¤ i e (renâ‰¤ Ïâ‰¤ Æ›Nâ‰¤Æ›Nâ€²)
renâ‰¤ {Ïâ€² = Ïâ€²} Ïâ‰¤ {Aâ‰¤ = Aâ‰¤} {Eâ€² = Eâ€²}
  (â‰¤wrap {Nâ€² = Nâ€²} {âˆ“s = âˆ“s} {Â±t} i e Æ›Nâ‰¤Æ›Nâ€²)
  rewrite renâˆ˜Æ›-wrap {E = Eâ€²} {âˆ“s = âˆ“s} {Â±t = Â±t} Ïâ€² (Æ› Nâ€²)
  = â‰¤wrap i e (renâ‰¤ Ïâ‰¤ Æ›Nâ‰¤Æ›Nâ€²)
renâ‰¤ Ïâ‰¤ (performâ‰¤perform Mâ‰¤) = performâ‰¤perform (renâ‰¤ Ïâ‰¤ Mâ‰¤)
renâ‰¤ Ïâ‰¤ (handleâ‰¤handle Hâ‰¤ Mâ‰¤) = handleâ‰¤handle (renâ‰¤Ê° Ïâ‰¤ Hâ‰¤) (renâ‰¤ Ïâ‰¤ Mâ‰¤)

renâ‰¤Ê° Ïâ‰¤ Hâ‰¤ = record
  { on-return = renâ‰¤ (renâ–·â‰¤ Ïâ‰¤) (on-return Hâ‰¤)
  ; on-perform = renâ‰¤-on-perform (on-perform Hâ‰¤) }
  where
    open _âŠ¢_â‰¤_â¦‚_â¡_

    renâ‰¤-on-perform : âˆ€ {Eh Ehâ€² Ms Msâ€²}
      â†’ On-Perform _ _ {Eh} {Ehâ€²} Ms Msâ€²
      â†’ On-Perform _ _ (ren-on-perform _ Ms) (ren-on-perform _ Msâ€²)
    renâ‰¤-on-perform [] = []
    renâ‰¤-on-perform ((refl , Bâ‡’Qâ‰¤ , domâ‰¡ , codâ‰¡ , Mâ‰¤) âˆ· Msâ‰¤)
      = (refl , Bâ‡’Qâ‰¤ , domâ‰¡ , codâ‰¡ , renâ‰¤ (renâ–·â‰¤ (renâ–·â‰¤ Ïâ‰¤)) Mâ‰¤) âˆ· renâ‰¤-on-perform Msâ‰¤
```

```
liftâ‰¤ : âˆ€ {Î“ Î“â€²} {Î“â‰¤ : Î“ â‰¤á´³ Î“â€²} {B Bâ€²} {Bâ‰¤ : B â‰¤ Bâ€²}
          {A Aâ€²} {Aâ‰¤ : A â‰¤ Aâ€²} {E Eâ€²} {Eâ‰¤ : E â‰¤áµ‰ Eâ€²} {M Mâ€²}
  â†’ Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ âŸ¨ Eâ‰¤ âŸ© Aâ‰¤
    ---------------------------------------
  â†’ Î“â‰¤ â–· Bâ‰¤ âŠ¢ lift M â‰¤á´¹ lift Mâ€² â¦‚ âŸ¨ Eâ‰¤ âŸ© Aâ‰¤
liftâ‰¤ = renâ‰¤ Sâ‰¤S

liftâ‰¤Ê° : âˆ€ {Î“ Î“â€²} {Î“â‰¤ : Î“ â‰¤á´³ Î“â€²} {A Aâ€²} {Aâ‰¤ : A â‰¤ Aâ€²}
          {P Pâ€² Q Qâ€²} {Pâ‰¤ : P â‰¤á¶œ Pâ€²} {Qâ‰¤ : Q â‰¤á¶œ Qâ€²} {H Hâ€²}
  â†’ Î“â‰¤ âŠ¢ H â‰¤ Hâ€² â¦‚ Pâ‰¤ â¡ Qâ‰¤
    --------------------------------------
  â†’ Î“â‰¤ â–· Aâ‰¤ âŠ¢ liftÊ° H â‰¤ liftÊ° Hâ€² â¦‚ Pâ‰¤ â¡ Qâ‰¤
liftâ‰¤Ê° = renâ‰¤Ê° Sâ‰¤S 
```

## Substitution {#substitution-prec}

Extension
```
subâ–·â‰¤ : âˆ€ {Î“ Î“â€² Î” Î”â€²} {Î“â‰¤ : Î“ â‰¤á´³ Î“â€²} {Î”â‰¤ : Î” â‰¤á´³ Î”â€²} {Ïƒ : Î“ â†’Ë¢ Î”} {Ïƒâ€² : Î“â€² â†’Ë¢ Î”â€²}
  â†’ Î“â‰¤ â†’Ë¢ Î”â‰¤ âˆ‹ Ïƒ â‰¤ Ïƒâ€²
    ------------------------------------------------------
  â†’ âˆ€ {A Aâ€²} {Aâ‰¤ : A â‰¤ Aâ€²} â†’ Î“â‰¤ â–· Aâ‰¤ â†’Ë¢ Î”â‰¤ â–· Aâ‰¤ âˆ‹ subâ–· Ïƒ â‰¤ subâ–· Ïƒâ€²
subâ–·â‰¤ Ïƒâ‰¤ Zâ‰¤Z       =  `â‰¤` Zâ‰¤Z
subâ–·â‰¤ Ïƒâ‰¤ (Sâ‰¤S xâ‰¤)  =  renâ‰¤ Sâ‰¤S (Ïƒâ‰¤ xâ‰¤)
```

Preservation of precision under substitution
```
subâ‰¤ : âˆ€ {Î“ Î“â€² Î” Î”â€²} {Î“â‰¤ : Î“ â‰¤á´³ Î“â€²} {Î”â‰¤ : Î” â‰¤á´³ Î”â€²} {Ïƒ : Î“ â†’Ë¢ Î”} {Ïƒâ€² : Î“â€² â†’Ë¢ Î”â€²}
  â†’ Î“â‰¤ â†’Ë¢ Î”â‰¤ âˆ‹ Ïƒ â‰¤ Ïƒâ€²
    -------------------------
  â†’ Î“â‰¤ â†’áµ€ Î”â‰¤ âˆ‹ sub Ïƒ â‰¤ sub Ïƒâ€²
subâ‰¤ Ïƒâ‰¤ (`â‰¤` x)              =  Ïƒâ‰¤ x
subâ‰¤ Ïƒâ‰¤ (Æ›â‰¤Æ› Nâ‰¤)             =  Æ›â‰¤Æ› (subâ‰¤ (subâ–·â‰¤ Ïƒâ‰¤) Nâ‰¤)
subâ‰¤ Ïƒâ‰¤ (Â·â‰¤Â· Lâ‰¤ Mâ‰¤)          =  Â·â‰¤Â· (subâ‰¤ Ïƒâ‰¤ Lâ‰¤) (subâ‰¤ Ïƒâ‰¤ Mâ‰¤)
subâ‰¤ Ïƒâ‰¤ ($â‰¤$ k)              =  $â‰¤$ k
subâ‰¤ Ïƒâ‰¤ (â¦…â¦†â‰¤â¦…â¦† _âŠ•_ Mâ‰¤ Nâ‰¤)     =  â¦…â¦†â‰¤â¦…â¦† _âŠ•_ (subâ‰¤ Ïƒâ‰¤ Mâ‰¤) (subâ‰¤ Ïƒâ‰¤ Nâ‰¤)
subâ‰¤ Ïƒâ‰¤ (â‡‘â‰¤â‡‘ g Mâ‰¤)           =  â‡‘â‰¤â‡‘ g (subâ‰¤ Ïƒâ‰¤ Mâ‰¤)
subâ‰¤ Ïƒâ‰¤ (â‰¤â‡‘ g Mâ‰¤)            =  â‰¤â‡‘ g (subâ‰¤ Ïƒâ‰¤ Mâ‰¤)
subâ‰¤ Ïƒâ‰¤ (castâ‰¤ e Mâ‰¤)           =  castâ‰¤ e (subâ‰¤ Ïƒâ‰¤ Mâ‰¤)
subâ‰¤ Ïƒâ‰¤ (â‰¤cast e Mâ‰¤)           =  â‰¤cast e (subâ‰¤ Ïƒâ‰¤ Mâ‰¤)
subâ‰¤ Ïƒâ‰¤ blameâ‰¤               =  blameâ‰¤
subâ‰¤ {Ïƒ = Ïƒ} Ïƒâ‰¤ {E = E} (wrapâ‰¤ {N = N} {âˆ“s = âˆ“s} {Â±t} i e Æ›Nâ‰¤Æ›Nâ€²)
  rewrite subâˆ˜Æ›-wrap {E = E} {âˆ“s = âˆ“s} {Â±t} Ïƒ (Æ› N)
  =  wrapâ‰¤ i e (subâ‰¤ Ïƒâ‰¤ Æ›Nâ‰¤Æ›Nâ€²)
subâ‰¤ {Ïƒâ€² = Ïƒâ€²} Ïƒâ‰¤ {Eâ€² = Eâ€²} (â‰¤wrap {Nâ€² = Nâ€²} {âˆ“s = âˆ“s} {Â±t} i e Æ›Nâ‰¤Æ›Nâ€²)
  rewrite subâˆ˜Æ›-wrap {E = Eâ€²} {âˆ“s = âˆ“s} {Â±t} Ïƒâ€² (Æ› Nâ€²)
  =  â‰¤wrap i e (subâ‰¤ Ïƒâ‰¤ Æ›Nâ‰¤Æ›Nâ€²)
subâ‰¤ Ïƒâ‰¤ (performâ‰¤perform Mâ‰¤) = performâ‰¤perform (subâ‰¤ Ïƒâ‰¤ Mâ‰¤)
subâ‰¤ Ïƒâ‰¤ (handleâ‰¤handle Hâ‰¤ Mâ‰¤) = handleâ‰¤handle subâ‰¤Ê° (subâ‰¤ Ïƒâ‰¤ Mâ‰¤)
  where
    open _âŠ¢_â‰¤_â¦‚_â¡_

    subâ‰¤-on-perform : âˆ€ {Eh Ehâ€² Ms Msâ€²}
      â†’ On-Perform _ _ {Eh} {Ehâ€²} Ms Msâ€²
      â†’ On-Perform _ _ (sub-on-perform _ Ms) (sub-on-perform _ Msâ€²)
    subâ‰¤-on-perform [] = []
    subâ‰¤-on-perform ((refl , Bâ‡’Qâ‰¤ , domâ‰¡ , codâ‰¡ , Mâ‰¤) âˆ· Msâ‰¤)
      = (refl , Bâ‡’Qâ‰¤ , domâ‰¡ , codâ‰¡ , subâ‰¤ (subâ–·â‰¤ (subâ–·â‰¤ Ïƒâ‰¤)) Mâ‰¤) âˆ· subâ‰¤-on-perform Msâ‰¤

    subâ‰¤Ê° = record
      { on-return = subâ‰¤ (subâ–·â‰¤ Ïƒâ‰¤) (on-return Hâ‰¤)
      ; on-perform = subâ‰¤-on-perform (on-perform Hâ‰¤) }
```

Preservation of precision under substitution, special case for beta

```
Ïƒâ‚€â‰¤Ïƒâ‚€ : âˆ€ {Î“ Î“â€² A Aâ€²} {M : âˆ€ {E} â†’ Î“ âŠ¢ âŸ¨ E âŸ© A} {Mâ€² : âˆ€ {Eâ€²} â†’ Î“â€² âŠ¢ âŸ¨ Eâ€² âŸ© Aâ€²} {Î“â‰¤ : Î“ â‰¤á´³ Î“â€²} {s : A â‰¤ Aâ€²}
  â†’ (âˆ€ {E Eâ€²} {Eâ‰¤ : E â‰¤áµ‰ Eâ€²} â†’ Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ âŸ¨ Eâ‰¤ âŸ© s)
  â†’ Î“â‰¤ â–· s â†’Ë¢ Î“â‰¤ âˆ‹ Ïƒâ‚€ M â‰¤ Ïƒâ‚€ Mâ€²
Ïƒâ‚€â‰¤Ïƒâ‚€ Mâ‰¤Mâ€² Zâ‰¤Z         =  Mâ‰¤Mâ€²
Ïƒâ‚€â‰¤Ïƒâ‚€ Mâ‰¤Mâ€² (Sâ‰¤S xâ‰¤xâ€²)  =  `â‰¤` xâ‰¤xâ€²

[]â‰¤[] : âˆ€ {Î“ Î“â€² A Aâ€² B Bâ€² E Eâ€² N Nâ€²} {M : âˆ€ {E} â†’ Î“ âŠ¢ âŸ¨ E âŸ© A} {Mâ€² : âˆ€ {Eâ€²} â†’ Î“â€² âŠ¢ âŸ¨ Eâ€² âŸ© Aâ€²} {Î“â‰¤ : Î“ â‰¤á´³ Î“â€²} {s : A â‰¤ Aâ€²} {t : B â‰¤ Bâ€²} {Eâ‰¤ : E â‰¤áµ‰ Eâ€²}
        â†’ Î“â‰¤ â–· s âŠ¢ N â‰¤á´¹ Nâ€² â¦‚ âŸ¨ Eâ‰¤ âŸ© t
        â†’ (âˆ€ {E Eâ€²} {Eâ‰¤ : E â‰¤áµ‰ Eâ€²} â†’ Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ âŸ¨ Eâ‰¤ âŸ© s)
          -----------------------------
        â†’ Î“â‰¤ âŠ¢ N [ M ] â‰¤á´¹ Nâ€² [ Mâ€² ] â¦‚ âŸ¨ Eâ‰¤ âŸ© t
[]â‰¤[] Nâ‰¤Nâ€² Mâ‰¤Mâ€² =  subâ‰¤ (Ïƒâ‚€â‰¤Ïƒâ‚€ Mâ‰¤Mâ€²) Nâ‰¤Nâ€²
```

## Relating a term to its type erasure

```
Æ›â‰¤Æ›â˜… : âˆ€ {Î“ Î“â€² A B E F Fâ€² N Nâ€²} {Î“â‰¤ : Î“ â‰¤á´³ Î“â€²} {Fâ‰¤ : F â‰¤áµ‰ Fâ€²} {p : A â‡’ âŸ¨ E âŸ© B â‰¤ â˜… â‡’ âŸ¨ â˜† âŸ© â˜…}
  â†’ Î“â‰¤ â–· dom p âŠ¢ N â‰¤á´¹ Nâ€² â¦‚ cod p
    ----------------------------
  â†’ Î“â‰¤ âŠ¢ Æ› N â‰¤á´¹ Æ›â˜… Nâ€² â¦‚ âŸ¨ Fâ‰¤ âŸ© (p â‡‘ â˜…â‡’â˜…)
Æ›â‰¤Æ›â˜… Nâ‰¤Nâ€² = â‰¤cast refl (Æ›â‰¤Æ› Nâ‰¤Nâ€²)

Â·â‰¤Â·â˜… : âˆ€ {Î“ Î“â€² A B E L Lâ€² M Mâ€²} {Î“â‰¤ : Î“ â‰¤á´³ Î“â€²} {p : A â‡’ âŸ¨ E âŸ© B â‰¤ â˜… â‡’ âŸ¨ â˜† âŸ© â˜…}
    (let âŸ¨ Eâ‰¤ âŸ© _ = cod p)
  â†’ Î“â‰¤ âŠ¢ L â‰¤á´¹ Lâ€² â¦‚ âŸ¨ Eâ‰¤ âŸ© (p â‡‘ â˜…â‡’â˜…)
  â†’ Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ âŸ¨ Eâ‰¤ âŸ© dom p
    ------------------------------
  â†’ Î“â‰¤ âŠ¢ L Â· M â‰¤á´¹ Lâ€² Â·â˜… Mâ€² â¦‚ cod p
Â·â‰¤Â·â˜… Lâ‰¤Lâ€² Mâ‰¤Mâ€² = Â·â‰¤Â· (â‰¤cast refl Lâ‰¤Lâ€²) Mâ‰¤Mâ€²

$â‰¤$â˜… : âˆ€ {Î“ Î“â€² E Î¹} {Î“â‰¤ : Î“ â‰¤á´³ Î“â€²} {Eâ‰¤ : E â‰¤áµ‰ â˜†} (k : rep Î¹) â†’ Î“â‰¤ âŠ¢ $ k â‰¤á´¹ $â˜… k â¦‚ âŸ¨ Eâ‰¤ âŸ© (Î¹ â‰¤â˜…)
$â‰¤$â˜… {Î¹ = Î¹} k  =  â‰¤â‡‘ ($ Î¹) ($â‰¤$ k)

â¦…â¦†â‰¤â¦…â¦†â˜… : âˆ€ {Î“ Î“â€² E Î¹ Î¹â€² Î¹â€³ M Mâ€² N Nâ€²} {Î“â‰¤ : Î“ â‰¤á´³ Î“â€²} {Eâ‰¤ : E â‰¤áµ‰ â˜†}
  â†’ (_âŠ•_ : rep Î¹ â†’ rep Î¹â€² â†’ rep Î¹â€³)
  â†’ Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ âŸ¨ Eâ‰¤ âŸ© (Î¹ â‰¤â˜…)
  â†’ Î“â‰¤ âŠ¢ N â‰¤á´¹ Nâ€² â¦‚ âŸ¨ Eâ‰¤ âŸ© (Î¹â€² â‰¤â˜…)
    ------------------------------------------
  â†’ Î“â‰¤ âŠ¢ M â¦… _âŠ•_ â¦† N â‰¤á´¹ Mâ€² â¦… _âŠ•_ â¦†â˜… Nâ€² â¦‚ âŸ¨ Eâ‰¤ âŸ© (Î¹â€³ â‰¤â˜…)
â¦…â¦†â‰¤â¦…â¦†â˜… _âŠ•_ Mâ‰¤Mâ€² Nâ‰¤Nâ€² = â‰¤cast refl (â¦…â¦†â‰¤â¦…â¦† _âŠ•_ (â‰¤cast refl Mâ‰¤Mâ€²) (â‰¤cast refl Nâ‰¤Nâ€²))

âŒˆ_âŒ‰â‰¤á´³ : âˆ€ (Î“ : Context) â†’ Î“ â‰¤á´³ âŒˆ Î“ âŒ‰á´³
âŒˆ âˆ… âŒ‰â‰¤á´³          =  âˆ…
âŒˆ Î“ â–· A âŒ‰â‰¤á´³      =  âŒˆ Î“ âŒ‰â‰¤á´³ â–· Aâ‰¤â˜…

âŒˆ_âŒ‰â‰¤Ë£ : âˆ€ {Î“ A} â†’ (x : Î“ âˆ‹ A) â†’ âŒˆ Î“ âŒ‰â‰¤á´³ âŠ¢ x â‰¤Ë£ âŒˆ x âŒ‰Ë£ â¦‚ Aâ‰¤â˜…
âŒˆ Z âŒ‰â‰¤Ë£          =  Zâ‰¤Z
âŒˆ S x âŒ‰â‰¤Ë£        =  Sâ‰¤S âŒˆ x âŒ‰â‰¤Ë£

âŒˆ_âŒ‰â‰¤ : âˆ€ {Î“ E A} {M : Î“ âŠ¢ âŸ¨ E âŸ© A} â†’ (m : Static M) â†’ âŒˆ Î“ âŒ‰â‰¤á´³ âŠ¢ M â‰¤á´¹ âŒˆ m âŒ‰ â¦‚ âŸ¨ Eâ‰¤â˜† âŸ© Aâ‰¤â˜…
âŒˆ ` x âŒ‰â‰¤         =  `â‰¤` âŒˆ x âŒ‰â‰¤Ë£
âŒˆ Æ› N âŒ‰â‰¤         =  Æ›â‰¤Æ›â˜… âŒˆ N âŒ‰â‰¤
âŒˆ L Â· M âŒ‰â‰¤       =  Â·â‰¤Â·â˜… âŒˆ L âŒ‰â‰¤ âŒˆ M âŒ‰â‰¤
âŒˆ $ k âŒ‰â‰¤         =  $â‰¤$â˜… k
âŒˆ M â¦… _âŠ•_ â¦† N âŒ‰â‰¤  =  â¦…â¦†â‰¤â¦…â¦†â˜… _âŠ•_ âŒˆ M âŒ‰â‰¤ âŒˆ N âŒ‰â‰¤
```

## Example {#example-prec}

```
incâ‰¤incâ˜… : âˆ… âŠ¢ inc â‰¤á´¹ incâ˜… â¦‚ âŸ¨ Îµâ‰¤â˜† âŸ© â„•â‡’â„•â‰¤â˜…
incâ‰¤incâ˜… = âŒˆ Inc âŒ‰â‰¤

incâ‰¤incâ˜…â€² : âˆ… âŠ¢ inc â‰¤á´¹ incâ˜…â€² â¦‚ âŸ¨ Îµâ‰¤â˜† âŸ© â„•â‡’â„•â‰¤â˜…
incâ‰¤incâ˜…â€² = â‰¤cast refl (reflá´¹ inc)

inc2â‰¤incâ˜…2â˜… : âˆ… âŠ¢ inc Â· ($ 2) â‰¤á´¹ incâ˜… Â·â˜… ($â˜… 2) â¦‚ âŸ¨ Îµâ‰¤â˜† âŸ© â„•â‰¤â˜…
inc2â‰¤incâ˜…2â˜… = âŒˆ Inc Â· ($ 2) âŒ‰â‰¤

inc2â‰¤incâ˜…â€²2â˜… : âˆ… âŠ¢ inc Â· ($ 2) â‰¤á´¹ incâ˜…â€² Â·â˜… ($â˜… 2) â¦‚ âŸ¨ Îµâ‰¤â˜† âŸ© â„•â‰¤â˜…
inc2â‰¤incâ˜…â€²2â˜… = Â·â‰¤Â·â˜… incâ‰¤incâ˜…â€² ($â‰¤$â˜… 2)
```

## Precision on frames

```
infix 3 _âŠ¢_â‡’á¶ _âˆ‹_â‰¤_

data _âŠ¢_â‡’á¶ _âˆ‹_â‰¤_ {Î“ Î“â€²} (Î“â‰¤ : Î“ â‰¤á´³ Î“â€²)
                {P Pâ€²} (Pâ‰¤ : P â‰¤á¶œ Pâ€²)
            : âˆ€ {Q Qâ€²} (Qâ‰¤ : Q â‰¤á¶œ Qâ€²)
            â†’            Frame Î“ P Q
            â†’            Frame Î“â€² Pâ€² Qâ€²
            â†’ Set where
  â–¡ : Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  Pâ‰¤ âˆ‹ â–¡ â‰¤ â–¡

  [_]Â·_ : âˆ€ {ğ¸ ğ¸â€²} {M Mâ€²} {Aâ‡’Bâ‰¤ : A â‡’ âŸ¨ E âŸ© B â‰¤ Aâ€² â‡’ âŸ¨ Eâ€² âŸ© Bâ€²}
      (let Eâ‰¤ = _â‰¤á¶œ_.effects (cod Aâ‡’Bâ‰¤))
    â†’ (ğ¸â‰¤ : Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  âŸ¨ Eâ‰¤ âŸ© Aâ‡’Bâ‰¤ âˆ‹ ğ¸ â‰¤ ğ¸â€²)
    â†’ (Mâ‰¤ : Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ âŸ¨ Eâ‰¤ âŸ© dom Aâ‡’Bâ‰¤)
      ----------------------------------------------
    â†’ Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  cod Aâ‡’Bâ‰¤ âˆ‹ [ ğ¸ ]Â· M â‰¤ [ ğ¸â€² ]Â· Mâ€²

  _Â·[_] : âˆ€ {V Vâ€²} {ğ¸ ğ¸â€²} {Aâ‡’Bâ‰¤ : A â‡’ âŸ¨ E âŸ© B â‰¤ Aâ€² â‡’ âŸ¨ Eâ€² âŸ© Bâ€²}
      (let Eâ‰¤ = _â‰¤á¶œ_.effects (cod Aâ‡’Bâ‰¤))
    â†’ ((v , vâ€² , _) : Value V Ã— Value Vâ€² Ã— (Î“â‰¤ âŠ¢ V â‰¤á´¹ Vâ€² â¦‚ âŸ¨ Eâ‰¤ âŸ© Aâ‡’Bâ‰¤))
    â†’ Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  âŸ¨ Eâ‰¤ âŸ© dom Aâ‡’Bâ‰¤ âˆ‹ ğ¸ â‰¤ ğ¸â€²
      ----------------------------------------------
    â†’ Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  cod Aâ‡’Bâ‰¤ âˆ‹ v Â·[ ğ¸ ] â‰¤ vâ€² Â·[ ğ¸â€² ]

  [_]â¦…_â¦†_ : âˆ€ {Î¹ Î¹â€² Î¹â€³} {ğ¸ ğ¸â€²} {M Mâ€²}
    â†’ (ğ¸â‰¤ : Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  âŸ¨ Eâ‰¤ âŸ© id âˆ‹ ğ¸ â‰¤ ğ¸â€²)
    â†’ (f : rep Î¹ â†’ rep Î¹â€² â†’ rep Î¹â€³)
    â†’ (Mâ‰¤ : Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ âŸ¨ Eâ‰¤ âŸ© id)
      ------------------------------------------------------
    â†’ Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  âŸ¨ Eâ‰¤ âŸ© id âˆ‹ [ ğ¸ ]â¦… f â¦† M â‰¤ [ ğ¸â€² ]â¦… f â¦† Mâ€²

  _â¦…_â¦†[_] : âˆ€ {Î¹ Î¹â€² Î¹â€³} {V Vâ€²} {ğ¸ ğ¸â€²}
    â†’ ((v , vâ€² , _) : Value V Ã— Value Vâ€² Ã— (Î“â‰¤ âŠ¢ V â‰¤á´¹ Vâ€² â¦‚ âŸ¨ Eâ‰¤ âŸ© id))
    â†’ (f : rep Î¹ â†’ rep Î¹â€² â†’ rep Î¹â€³)
    â†’ Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  âŸ¨ Eâ‰¤ âŸ© id âˆ‹ ğ¸ â‰¤ ğ¸â€²
      ------------------------------------------------------
    â†’ Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  âŸ¨ Eâ‰¤ âŸ© id âˆ‹ v â¦… f â¦†[ ğ¸ ] â‰¤ vâ€² â¦… f â¦†[ ğ¸â€² ]

  [_]â‡‘_ : âˆ€ {G ğ¸ ğ¸â€²}
    â†’ Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  âŸ¨ Eâ‰¤ âŸ© id âˆ‹ ğ¸ â‰¤ ğ¸â€²
    â†’ (g : Ground G)
      --------------------------------------------
    â†’ Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  âŸ¨ Eâ‰¤ âŸ© id âˆ‹ [ ğ¸ ]â‡‘ g â‰¤ [ ğ¸â€² ]â‡‘ g

  â‰¤â‡‘ : âˆ€ {G} {Aâ‰¤G : Aâ€² â‰¤ G} {g : Ground G} {ğ¸ ğ¸â€²}
    â†’ Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  âŸ¨ Eâ‰¤ âŸ© Aâ‰¤G âˆ‹ ğ¸ â‰¤ ğ¸â€²
      --------------------------------------------
    â†’ Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  âŸ¨ Eâ‰¤ âŸ© (Aâ‰¤G â‡‘ g) âˆ‹ ğ¸ â‰¤ [ ğ¸â€² ]â‡‘ g

  castâ‰¤ : âˆ€ {A B C} {A=>B : A =>á¶œ B} {Bâ‰¤C : B â‰¤á¶œ C} {Aâ‰¤C : A â‰¤á¶œ C} {ğ¸ ğ¸â€²}
    â†’ commuteâ‰¤á¶œ A=>B Bâ‰¤C Aâ‰¤C
    â†’ Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  Aâ‰¤C âˆ‹ ğ¸ â‰¤ ğ¸â€²
      --------------------------------------------
    â†’ Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  Bâ‰¤C âˆ‹ `cast A=>B [ ğ¸ ] â‰¤ ğ¸â€²

  â‰¤cast : âˆ€ {A B C} {Aâ‰¤B : A â‰¤á¶œ B} {B=>C : B =>á¶œ C} {Aâ‰¤C : A â‰¤á¶œ C} {ğ¸ ğ¸â€²}
    â†’ â‰¤commuteá¶œ Aâ‰¤B B=>C Aâ‰¤C
    â†’ Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  Aâ‰¤B âˆ‹ ğ¸ â‰¤ ğ¸â€²
      --------------------------------------------
    â†’ Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  Aâ‰¤C âˆ‹ ğ¸ â‰¤ `cast B=>C [ ğ¸â€² ]

  â€³perform_[_]_ : âˆ€ {e} {ğ¸ ğ¸â€²}
    â†’ ((eâˆˆE , eâˆˆEâ€²) : e âˆˆâ˜† E Ã— e âˆˆâ˜† Eâ€²)
    â†’ Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  âŸ¨ Eâ‰¤ âŸ© id âˆ‹ ğ¸ â‰¤ ğ¸â€²
    â†’ âˆ€ {A}
    â†’ (eq : response e â‰¡ A)
      --------------------------------------------------------------------------
    â†’ Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  âŸ¨ Eâ‰¤ âŸ© id âˆ‹ (â€³perform eâˆˆE [ ğ¸ ] eq) â‰¤ (â€³perform eâˆˆEâ€² [ ğ¸â€² ] eq)

  â€²handle_[_] : âˆ€ {Qâ‚ Qâ‚â€² Qâ‚‚ Qâ‚‚â€²} {Qâ‚â‰¤ : Qâ‚ â‰¤á¶œ Qâ‚â€²} {Qâ‚‚â‰¤ : Qâ‚‚ â‰¤á¶œ Qâ‚‚â€²} {H Hâ€²} {ğ¸ ğ¸â€²}
    â†’ Î“â‰¤ âŠ¢ H â‰¤ Hâ€² â¦‚ Qâ‚â‰¤ â¡ Qâ‚‚â‰¤
    â†’ Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  Qâ‚â‰¤ âˆ‹ ğ¸ â‰¤ ğ¸â€²
      ----------------------------------------------------
    â†’ Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  Qâ‚‚â‰¤ âˆ‹ â€²handle H [ ğ¸ ] â‰¤ â€²handle Hâ€² [ ğ¸â€² ]

renâ‰¤á¶  : âˆ€ {Ï : Î“ â†’á´¿ Î”} {Ïâ€² : Î“â€² â†’á´¿ Î”â€²} {ğ¸ ğ¸â€²}
  â†’ Î“â‰¤ â†’á´¿ Î”â‰¤ âˆ‹ Ï â‰¤ Ïâ€²
  â†’ Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  Qâ‰¤ âˆ‹ ğ¸ â‰¤ ğ¸â€²
  â†’ Î”â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  Qâ‰¤ âˆ‹ rená¶  Ï ğ¸ â‰¤ rená¶  Ïâ€² ğ¸â€²
renâ‰¤á¶  Ïâ‰¤ â–¡ = â–¡
renâ‰¤á¶  Ïâ‰¤ ([ ğ¸â‰¤ ]Â· Mâ‰¤) = [ renâ‰¤á¶  Ïâ‰¤ ğ¸â‰¤ ]Â· renâ‰¤ Ïâ‰¤ Mâ‰¤
renâ‰¤á¶  Ïâ‰¤ ((v , vâ€² , Vâ‰¤) Â·[ ğ¸â‰¤ ]) = (ren-val _ v , ren-val _ vâ€² , renâ‰¤ Ïâ‰¤ Vâ‰¤) Â·[ renâ‰¤á¶  Ïâ‰¤ ğ¸â‰¤ ]
renâ‰¤á¶  Ïâ‰¤ ([ ğ¸â‰¤ ]â¦… f â¦† Mâ‰¤) = [ renâ‰¤á¶  Ïâ‰¤ ğ¸â‰¤ ]â¦… f â¦† renâ‰¤ Ïâ‰¤ Mâ‰¤
renâ‰¤á¶  Ïâ‰¤ ((v , vâ€² , Vâ‰¤) â¦… f â¦†[ ğ¸â‰¤ ]) = (ren-val _ v , ren-val _ vâ€² , renâ‰¤ Ïâ‰¤ Vâ‰¤) â¦… f â¦†[ renâ‰¤á¶  Ïâ‰¤ ğ¸â‰¤ ]
renâ‰¤á¶  Ïâ‰¤ ([ ğ¸â‰¤ ]â‡‘ g) = [ renâ‰¤á¶  Ïâ‰¤ ğ¸â‰¤ ]â‡‘ g
renâ‰¤á¶  Ïâ‰¤ (â‰¤â‡‘ ğ¸â‰¤) = â‰¤â‡‘ (renâ‰¤á¶  Ïâ‰¤ ğ¸â‰¤)
renâ‰¤á¶  Ïâ‰¤ (castâ‰¤ comm ğ¸â‰¤) = castâ‰¤ comm (renâ‰¤á¶  Ïâ‰¤ ğ¸â‰¤)
renâ‰¤á¶  Ïâ‰¤ (â‰¤cast comm ğ¸â‰¤) = â‰¤cast comm (renâ‰¤á¶  Ïâ‰¤ ğ¸â‰¤)
renâ‰¤á¶  Ïâ‰¤ (â€³perform (eâˆˆE , eâˆˆEâ€²) [ ğ¸â‰¤ ] eq) = â€³perform (eâˆˆE , eâˆˆEâ€²) [ renâ‰¤á¶  Ïâ‰¤ ğ¸â‰¤ ] eq
renâ‰¤á¶  Ïâ‰¤ (â€²handle Hâ‰¤ [ ğ¸â‰¤ ]) = â€²handle (renâ‰¤Ê° Ïâ‰¤ Hâ‰¤) [ renâ‰¤á¶  Ïâ‰¤ ğ¸â‰¤ ]

liftâ‰¤á¶  : âˆ€ {ğ¸ ğ¸â€²}
  â†’ Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  Qâ‰¤ âˆ‹ ğ¸ â‰¤ ğ¸â€²
  â†’ Î“â‰¤ â–· Aâ‰¤ âŠ¢ Pâ‰¤ â‡’á¶  Qâ‰¤ âˆ‹ liftá¶  ğ¸ â‰¤ liftá¶  ğ¸â€²
liftâ‰¤á¶  = renâ‰¤á¶  Sâ‰¤S

âŸ¦âŸ§â‰¤âŸ¦âŸ§ : âˆ€ {ğ¸ ğ¸â€² M Mâ€²}
  â†’ Î“â‰¤ âŠ¢ Pâ‰¤ â‡’á¶  Qâ‰¤ âˆ‹ ğ¸ â‰¤ ğ¸â€²
  â†’ Î“â‰¤ âŠ¢ M â‰¤á´¹ Mâ€² â¦‚ Pâ‰¤
  â†’ Î“â‰¤ âŠ¢ ğ¸ âŸ¦ M âŸ§ â‰¤á´¹ ğ¸â€² âŸ¦ Mâ€² âŸ§ â¦‚ Qâ‰¤
âŸ¦âŸ§â‰¤âŸ¦âŸ§ â–¡ Mâ‰¤ = Mâ‰¤
âŸ¦âŸ§â‰¤âŸ¦âŸ§ ([ ğ¸â‰¤ ]Â· Nâ‰¤) Mâ‰¤ = Â·â‰¤Â· (âŸ¦âŸ§â‰¤âŸ¦âŸ§ ğ¸â‰¤ Mâ‰¤) Nâ‰¤
âŸ¦âŸ§â‰¤âŸ¦âŸ§ ((v , vâ€² , Vâ‰¤) Â·[ ğ¸â‰¤ ]) Mâ‰¤ = Â·â‰¤Â· Vâ‰¤ (âŸ¦âŸ§â‰¤âŸ¦âŸ§ ğ¸â‰¤ Mâ‰¤)
âŸ¦âŸ§â‰¤âŸ¦âŸ§ ([ ğ¸â‰¤ ]â¦… f â¦† Nâ‰¤) Mâ‰¤ = â¦…â¦†â‰¤â¦…â¦† f (âŸ¦âŸ§â‰¤âŸ¦âŸ§ ğ¸â‰¤ Mâ‰¤) Nâ‰¤
âŸ¦âŸ§â‰¤âŸ¦âŸ§ ((v , vâ€² , Vâ‰¤) â¦… f â¦†[ ğ¸â‰¤ ]) Mâ‰¤ = â¦…â¦†â‰¤â¦…â¦† f Vâ‰¤ (âŸ¦âŸ§â‰¤âŸ¦âŸ§ ğ¸â‰¤ Mâ‰¤)
âŸ¦âŸ§â‰¤âŸ¦âŸ§ ([ ğ¸â‰¤ ]â‡‘ g) Mâ‰¤ = â‡‘â‰¤â‡‘ g (âŸ¦âŸ§â‰¤âŸ¦âŸ§ ğ¸â‰¤ Mâ‰¤)
âŸ¦âŸ§â‰¤âŸ¦âŸ§ (â‰¤â‡‘ ğ¸â‰¤) Mâ‰¤ = â‰¤â‡‘ _ (âŸ¦âŸ§â‰¤âŸ¦âŸ§ ğ¸â‰¤ Mâ‰¤)
âŸ¦âŸ§â‰¤âŸ¦âŸ§ (castâ‰¤ comm ğ¸â‰¤) Mâ‰¤ = castâ‰¤ comm (âŸ¦âŸ§â‰¤âŸ¦âŸ§ ğ¸â‰¤ Mâ‰¤)
âŸ¦âŸ§â‰¤âŸ¦âŸ§ (â‰¤cast comm ğ¸â‰¤) Mâ‰¤ = â‰¤cast comm (âŸ¦âŸ§â‰¤âŸ¦âŸ§ ğ¸â‰¤ Mâ‰¤)
âŸ¦âŸ§â‰¤âŸ¦âŸ§ (â€³perform (eâˆˆE , eâˆˆEâ€²) [ ğ¸â‰¤ ] eq) Mâ‰¤ = performâ‰¤perform (âŸ¦âŸ§â‰¤âŸ¦âŸ§ ğ¸â‰¤ Mâ‰¤)
âŸ¦âŸ§â‰¤âŸ¦âŸ§ (â€²handle Hâ‰¤ [ ğ¸â‰¤ ]) Mâ‰¤ = handleâ‰¤handle Hâ‰¤ (âŸ¦âŸ§â‰¤âŸ¦âŸ§ ğ¸â‰¤ Mâ‰¤)
```
